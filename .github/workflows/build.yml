name: Build Windows Installer

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Python dependencies
        run: |
          pip install pyinstaller sounddevice numpy librosa keyboard scipy numba cffi soundfile
      
      - name: Build Windows EXE
        run: |
          pyinstaller --noconsole --onefile --name "Soundboard Pro" --icon=icon.ico --add-data "ui;ui" --add-data "sounds;sounds" --add-data "config.json;." --hidden-import sounddevice --hidden-import numpy --hidden-import librosa --hidden-import scipy --hidden-import numba --hidden-import cffi --hidden-import soundfile --hidden-import keyboard app.py
      
      - name: Install Inno Setup
        run: |
          choco install innosetup -y
      
      - name: Build Windows Installer
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer.iss
        shell: powershell
      
      - name: Upload Windows Installer
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: installer_output/*.exe

  create-release:
    needs: [build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Download Windows Installer
        uses: actions/download-artifact@v4
        with:
          name: windows-installer
          path: ./windows
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ./windows/*.exe
          body: |
            # ğŸµ Soundboard Pro ${{ github.ref_name }}
            
            ## ğŸ“¥ Download
            **Windows Installer:** Download the `.exe` file below
            
            ## ğŸ“‹ Requirements
            - **Windows 10 or 11** (64-bit)
            - **VB-Audio Cable:** https://vb-audio.com/Cable/
            - **Run as Administrator** for global hotkeys to work in games
            
            ## âœ¨ Features
            - ğŸ® Global hotkeys (works in games, Discord, anywhere)
            - ğŸ¤ Voice passthrough (talk while sounds play)
            - ğŸ§ Dual audio output (virtual mic + headphones)
            - ğŸ¨ Modern dark UI with smooth animations
            - ğŸ’¾ Auto-save all settings, volumes, and hotkeys
            - ğŸ”„ Monitor toggle (hear yourself or not)
            
            ## ğŸš€ Quick Start
            1. Download the installer below
            2. Install VB-Audio Cable if you haven't already
            3. Run Soundboard Pro installer
            4. Configure audio devices in Settings
            5. Add sounds and set hotkeys!
            
            ## ğŸ› Issues?
            Report bugs at: https://github.com/patrick-1480/soundboard-pro/issues
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}