name: Build Windows Installer

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Python dependencies
        run: |
          pip install pyinstaller sounddevice numpy librosa keyboard scipy numba cffi soundfile
      
      - name: Build Windows EXE
        run: |
          pyinstaller --noconsole --onefile --name "Soundboard Pro" --icon=icon.ico --add-data "ui;ui" --add-data "sounds;sounds" --add-data "config.json;." --hidden-import sounddevice --hidden-import numpy --hidden-import librosa --hidden-import scipy --hidden-import numba --hidden-import cffi --hidden-import soundfile --hidden-import keyboard app.py
      
      - name: Install Inno Setup
        run: |
          choco install innosetup -y
      
      - name: Build Windows Installer
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer.iss
        shell: powershell
      
      - name: Upload Windows Installer
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: installer_output/*.exe

  create-release:
    needs: [build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Download Windows Installer
        uses: actions/download-artifact@v4
        with:
          name: windows-installer
          path: ./windows
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ./windows/*.exe
          body: |
            # ðŸŽ‰ Soundboard Pro ${{ github.ref_name }}
            
            ## ðŸ“¥ Download
            **Windows Installer:** Download the `.exe` file below
            
            ## âœ¨ What's New in v3.0.0
            - âš¡ **10x Faster Startup** - Opens in <1 second!
            - ðŸŽ¨ **Theme System** - Dark, Light, and Purple modes
            - ðŸ“ **Drag & Drop** - Drag MP3/WAV files to import
            - ðŸŽµ **Audio Effects** - Fade, Echo, Normalize, Speed, Pitch
            - ðŸ”„ **Auto-Version** - Easier maintenance
            - ðŸ›¡ï¸ **Security Updates** - Automated dependency management
            
            ## ðŸ“‹ Requirements
            - **Windows 10 or 11** (64-bit)
            - **VB-Audio Cable:** https://vb-audio.com/Cable/
            - **Run as Administrator** for global hotkeys
            
            ## ðŸš€ Quick Start
            1. Download installer below
            2. Install VB-Audio Cable if needed
            3. Run Soundboard Pro installer
            4. Configure audio devices in Settings
            5. Add sounds and set hotkeys!
            
            ## ðŸ› Issues?
            Report bugs at: https://github.com/patrick-1480/soundboard-pro/issues
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}